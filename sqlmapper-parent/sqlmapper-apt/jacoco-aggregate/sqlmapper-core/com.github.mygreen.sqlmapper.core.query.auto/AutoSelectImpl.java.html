<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AutoSelectImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">sqlmapper-apt</a> &gt; <a href="../index.html" class="el_bundle">sqlmapper-core</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.sqlmapper.core.query.auto</a> &gt; <span class="el_source">AutoSelectImpl.java</span></div><h1>AutoSelectImpl.java</h1><pre class="source lang-java linenums">package com.github.mygreen.sqlmapper.core.query.auto;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Stream;

import com.github.mygreen.sqlmapper.core.SqlMapperContext;
import com.github.mygreen.sqlmapper.core.dialect.Dialect;
import com.github.mygreen.sqlmapper.core.event.PostSelectEvent;
import com.github.mygreen.sqlmapper.core.meta.EntityMeta;
import com.github.mygreen.sqlmapper.core.meta.PropertyMeta;
import com.github.mygreen.sqlmapper.core.meta.PropertyValueInvoker;
import com.github.mygreen.sqlmapper.core.query.IllegalOperateException;
import com.github.mygreen.sqlmapper.core.query.JoinAssociation;
import com.github.mygreen.sqlmapper.core.query.JoinCondition;
import com.github.mygreen.sqlmapper.core.query.JoinType;
import com.github.mygreen.sqlmapper.core.query.SelectForUpdateType;
import com.github.mygreen.sqlmapper.metamodel.EntityPath;
import com.github.mygreen.sqlmapper.metamodel.OrderSpecifier;
import com.github.mygreen.sqlmapper.metamodel.Predicate;
import com.github.mygreen.sqlmapper.metamodel.PropertyPath;

import lombok.Getter;
import lombok.NonNull;

/**
 * 抽出を行うSQLを自動生成するクエリの実装です。
 *
 * @author T.TSUCHIE
 *
 * @param &lt;T&gt; 処理対象となるエンティティの型
 */
public class AutoSelectImpl&lt;T&gt; implements AutoSelect&lt;T&gt; {

    /**
     * SqlMapperの設定情報。
     */
<span class="fc" id="L45">    @Getter</span>
    private final SqlMapperContext context;

<span class="fc" id="L48">    @Getter</span>
    private final Class&lt;T&gt; baseClass;

<span class="fc" id="L51">    @Getter</span>
    private final EntityPath&lt;T&gt; entityPath;

<span class="fc" id="L54">    @Getter</span>
    private final EntityMeta entityMeta;

    /**
     * エンティティタイプとメタ情報のマップ
     */
<span class="fc" id="L60">    @Getter</span>
    private final Map&lt;Class&lt;?&gt;, EntityMeta&gt; entityMetaMap = new HashMap&lt;&gt;();

    /**
     * SQLのヒントです。
     */
<span class="fc" id="L66">    @Getter</span>
    private String hint;

    /**
     * 取得するレコード数の上限値です。
     * &lt;p&gt;負の値の時は無視します。
     */
<span class="fc" id="L73">    @Getter</span>
    private int limit = -1;

    /**
     * 取得するレコード数の開始位置です。
     * &lt;p&gt;負の値の時は無視します。
     */
<span class="pc" id="L80">    @Getter</span>
    private int offset = -1;

    /**
     * select句へ追加するプロパティです。
     */
<span class="fc" id="L86">    @Getter</span>
    private final Set&lt;PropertyPath&lt;?&gt;&gt; includesProperties = new LinkedHashSet&lt;&gt;();

    /**
     * select句から除外するプロパティです。
     */
<span class="fc" id="L92">    @Getter</span>
    private final Set&lt;PropertyPath&lt;?&gt;&gt; excludesProperties = new LinkedHashSet&lt;&gt;();

    /**
     * テーブルの結合条件の一覧です。
     */
<span class="fc" id="L98">    @SuppressWarnings(&quot;rawtypes&quot;)</span>
<span class="fc" id="L99">    @Getter</span>
    private final List&lt;JoinCondition&gt; joinConditions = new ArrayList&lt;&gt;();

    /**
     * エンティティの構成定義の一覧です
     */
<span class="fc" id="L105">    @SuppressWarnings(&quot;rawtypes&quot;)</span>
<span class="fc" id="L106">    @Getter</span>
    private final List&lt;JoinAssociation&gt; joinAssociations = new ArrayList&lt;&gt;();

    /**
     * 検索条件です。
     */
<span class="fc" id="L112">    @Getter</span>
    private Predicate where;

    /**
     * ソート順です。
     */
<span class="fc" id="L118">    @Getter</span>
    private List&lt;OrderSpecifier&gt; orders = new ArrayList&lt;&gt;();

    /**
     * 検索条件で指定したIDプロパティの値の配列です。
     */
<span class="fc" id="L124">    @Getter</span>
    private Object[] idPropertyValues;

    /**
     * バージョンプロパティの値です。
     */
<span class="fc" id="L130">    @Getter</span>
    private Object versionPropertyValue;

    /**
     * SELECT ～ FOR UPDATEのタイプです。
     */
<span class="fc" id="L136">    @Getter</span>
    private SelectForUpdateType forUpdateType;

    /**
     * SELECT ～ FOR UPDATEでの待機時間 (秒単位) です。
     */
<span class="pc" id="L142">    @Getter</span>
    private int forUpdateWaitSeconds = 0;

    /**
     * {@link AutoSelectImpl}を作成します。
     * @param context SqlMapperの設定情報。
     * @param entityPath マッピングするエンティティのメタモデル。
     */
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="pc bpc" id="L151" title="2 of 4 branches missed.">    public AutoSelectImpl(@NonNull SqlMapperContext context, @NonNull EntityPath&lt;T&gt; entityPath) {</span>
<span class="fc" id="L152">        this.context = context;</span>
<span class="fc" id="L153">        this.entityPath = entityPath;</span>
<span class="fc" id="L154">        this.entityMeta = context.getEntityMetaFactory().create(entityPath.getType());</span>
<span class="fc" id="L155">        this.baseClass = (Class&lt;T&gt;)entityMeta.getEntityType();</span>

<span class="fc" id="L157">        this.entityMetaMap.put(entityPath.getType(), context.getEntityMetaFactory().create(entityPath.getType()));</span>
<span class="fc" id="L158">    }</span>

    @Override
    public AutoSelectImpl&lt;T&gt; hint(String hint) {
<span class="nc" id="L162">        this.hint = hint;</span>
<span class="nc" id="L163">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; limit(int limit) {
<span class="nc" id="L168">        this.limit = limit;</span>
<span class="nc" id="L169">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; offset(int offset) {
<span class="nc" id="L174">        this.offset = offset;</span>
<span class="nc" id="L175">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; includes(final PropertyPath&lt;?&gt;... properties) {

<span class="nc bnc" id="L181" title="All 2 branches missed.">        for(PropertyPath&lt;?&gt; prop : properties) {</span>
<span class="nc" id="L182">            this.includesProperties.add(prop);</span>
        }

<span class="nc" id="L185">        return this;</span>

    }

    @Override
    public AutoSelectImpl&lt;T&gt; excludes(final PropertyPath&lt;?&gt;... properties) {

<span class="nc bnc" id="L192" title="All 2 branches missed.">        for(PropertyPath&lt;?&gt; prop : properties) {</span>
<span class="nc" id="L193">            this.excludesProperties.add(prop);</span>
        }

<span class="nc" id="L196">        return this;</span>

    }

    @Override
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">    public &lt;ENTITY extends EntityPath&lt;?&gt;&gt; AutoSelectImpl&lt;T&gt; innerJoin(@NonNull ENTITY toEntityPath,</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            @NonNull JoinCondition.Conditioner&lt;ENTITY&gt; conditioner) {</span>

<span class="fc" id="L204">        JoinCondition&lt;ENTITY&gt; condition = new JoinCondition&lt;&gt;(JoinType.INNER, toEntityPath, conditioner);</span>
<span class="fc" id="L205">        validateJoinCondition(condition);</span>

<span class="fc" id="L207">        this.entityMetaMap.put(toEntityPath.getType(), context.getEntityMetaFactory().create(toEntityPath.getType()));</span>
<span class="fc" id="L208">        this.joinConditions.add(condition);</span>
<span class="fc" id="L209">        return this;</span>
    }

    @Override
<span class="nc bnc" id="L213" title="All 2 branches missed.">    public &lt;ENTITY extends EntityPath&lt;?&gt;&gt; AutoSelectImpl&lt;T&gt; leftJoin(@NonNull ENTITY toEntityPath,</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            @NonNull JoinCondition.Conditioner&lt;ENTITY&gt; conditioner) {</span>

<span class="nc" id="L216">        JoinCondition&lt;ENTITY&gt; condition = new JoinCondition&lt;&gt;(JoinType.LEFT_OUTER, toEntityPath, conditioner);</span>
<span class="nc" id="L217">        validateJoinCondition(condition);</span>

<span class="nc" id="L219">        this.entityMetaMap.put(toEntityPath.getType(), context.getEntityMetaFactory().create(toEntityPath.getType()));</span>
<span class="nc" id="L220">        this.joinConditions.add(condition);</span>

<span class="nc" id="L222">        return this;</span>
    }

    /**
     * 結合条件の一覧に既に同じテーブルのエンティティ情報が含まれいえるか検査します。
     * &lt;ul&gt;
     *   &lt;li&gt;比較は、結合先のエンティティ情報({@link EntityPath})既に存在するかどうか。&lt;/li&gt;
     *   &lt;li&gt;結合種別({@link JoinType}) は無視します。&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param condition 結合条件
     * @return 同じエンティティの組み合わせが含まれているとき {@literal true} を返します
     * @throws IllegalOperateException 既に同じ組み合わせのエンティティ（テーブル）を指定しているときにスローされます。
     */
    private void validateJoinCondition(JoinCondition&lt;?&gt; condition) {

        // 同じ組み合わせのエンティティが存在しかチェックします。
<span class="fc bfc" id="L239" title="All 2 branches covered.">        for(JoinCondition&lt;?&gt; target : joinConditions) {</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">            if(target.getToEntity().equals(condition.getToEntity())) {</span>

                // 同じ組み合わせの場合
<span class="nc" id="L243">                throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.existsSameJoinEntity&quot;)</span>
<span class="nc" id="L244">                        .param(&quot;toEntity&quot;, condition.getToEntity().getPathMeta().getElement())</span>
<span class="nc" id="L245">                        .format());</span>
            }
<span class="fc" id="L247">        }</span>

<span class="fc" id="L249">    }</span>

    @Override
<span class="pc bpc" id="L252" title="2 of 4 branches missed.">    public &lt;E1, E2&gt; AutoSelectImpl&lt;T&gt; associate(@NonNull EntityPath&lt;E1&gt; entityPath1, @NonNull EntityPath&lt;E2&gt; entityPath2,</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            @NonNull JoinAssociation.Associator&lt;E1, E2&gt; associator) {</span>

<span class="fc" id="L255">        JoinAssociation&lt;E1, E2&gt; association = new JoinAssociation&lt;&gt;(entityPath1, entityPath2, associator);</span>

        // 同じ組み合わせのエンティティが存在しないかチェックします
<span class="fc bfc" id="L258" title="All 2 branches covered.">        for(JoinAssociation&lt;?, ?&gt; target : joinAssociations) {</span>
<span class="pc bpc" id="L259" title="3 of 4 branches missed.">            if((target.getEntity1().equals(association.getEntity1()) &amp;&amp; target.getEntity2().equals(association.getEntity2()))</span>
<span class="pc bpc" id="L260" title="3 of 4 branches missed.">                    || (target.getEntity1().equals(association.getEntity2()) &amp;&amp; target.getEntity2().equals(association.getEntity1()))</span>
                    ) {
                // 同じ組み合わせの場合 - エンティティ1、エンティティ2の順番は考慮しません。
<span class="nc" id="L263">                throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.existsSameAssociateEntity&quot;)</span>
<span class="nc" id="L264">                        .param(&quot;entity1&quot;, association.getEntity1().getPathMeta().getElement())</span>
<span class="nc" id="L265">                        .param(&quot;entity2&quot;, association.getEntity2().getPathMeta().getElement())</span>
<span class="nc" id="L266">                        .format());</span>
            }
<span class="fc" id="L268">        }</span>

<span class="fc" id="L270">        this.joinAssociations.add(association);</span>
<span class="fc" id="L271">        return this;</span>
    }

    @Override
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">    public AutoSelectImpl&lt;T&gt; where(@NonNull Predicate where) {</span>
<span class="fc" id="L276">        this.where = where;</span>
<span class="fc" id="L277">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; orderBy(OrderSpecifier... orders) {
        //TODO: 追加ではなく、上書き（直接変数に代入）する
<span class="fc" id="L283">        this.orders.addAll(Arrays.asList(orders));</span>
<span class="fc" id="L284">        return this;</span>
    }

    @Override
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">    public AutoSelectImpl&lt;T&gt; id(@NonNull final Object... idPropertyValues) {</span>

<span class="fc" id="L290">        Optional&lt;PropertyMeta&gt; embeddedIdPropertyMeta = entityMeta.getEmbeddedIdPropertyMeta();</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if(isEmbeddedProperty(idPropertyValues, embeddedIdPropertyMeta)) {</span>
            // 埋め込みIDのとき
<span class="nc" id="L293">            this.idPropertyValues = getEmbeddedIdValue(idPropertyValues, embeddedIdPropertyMeta.get().getEmbeddedablePopertyMetaList());</span>
        } else {
<span class="fc" id="L295">            List&lt;PropertyMeta&gt; idPropertyMetaList = entityMeta.getIdPropertyMetaList();</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">            if(idPropertyMetaList.size() != idPropertyValues.length) {</span>
<span class="nc" id="L297">                throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.noMatchIdPropertySize&quot;)</span>
<span class="nc" id="L298">                        .paramWithClass(&quot;entityType&quot;, entityPath.getType())</span>
<span class="nc" id="L299">                        .param(&quot;actualSize&quot;, idPropertyValues.length)</span>
<span class="nc" id="L300">                        .param(&quot;expectedSize&quot;, idPropertyMetaList.size())</span>
<span class="nc" id="L301">                        .format());</span>
            }

<span class="fc" id="L304">            this.idPropertyValues = idPropertyValues;</span>
        }

<span class="fc" id="L307">        return this;</span>
    }

    /**
     * IDのクラスタイプが埋め込みIDであるかどうか。
     * @param idPropertyValues 判定対象の値
     * @param embeddedIdPropertyMeta 埋め込みIDのメタ情報
     * @return {@literal true}のとき埋め込みID。
     */
    private boolean isEmbeddedProperty(Object[] idPropertyValues, Optional&lt;PropertyMeta&gt; embeddedIdPropertyMeta) {
<span class="pc bpc" id="L317" title="3 of 4 branches missed.">        if(idPropertyValues.length != 0 || embeddedIdPropertyMeta.isEmpty()) {</span>
<span class="fc" id="L318">            return false;</span>
        }

<span class="nc" id="L321">        Class&lt;?&gt; embeddedType = embeddedIdPropertyMeta.get().getPropertyType();</span>
<span class="nc" id="L322">        return embeddedType.isAssignableFrom(idPropertyValues[0].getClass());</span>
    }

    /**
     * 埋め込みIDの各プロパティの値を取得する。
     * @param value 埋め込みIDのインスタンス
     * @param embeddablePropertyList 埋め込みIDのプロパティのメタ情報
     * @return 埋め込みIDのプロパティの値
     */
    private Object[] getEmbeddedIdValue(Object value, Collection&lt;PropertyMeta&gt; embeddablePropertyList) {

<span class="nc" id="L333">        List&lt;Object&gt; idValueList = new ArrayList&lt;&gt;(embeddablePropertyList.size());</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        for(PropertyMeta propertyMeta : embeddablePropertyList) {</span>
<span class="nc" id="L335">            idValueList.add(PropertyValueInvoker.getPropertyValue(propertyMeta, value));</span>
<span class="nc" id="L336">        }</span>

<span class="nc" id="L338">        return idValueList.toArray(new Object[idValueList.size()]);</span>
    }

    @Override
<span class="nc bnc" id="L342" title="All 2 branches missed.">    public AutoSelectImpl&lt;T&gt; version(@NonNull final Object versionPropertyValue) {</span>

<span class="nc bnc" id="L344" title="All 2 branches missed.">        if(!entityMeta.hasVersionPropertyMeta()) {</span>
<span class="nc" id="L345">            throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.noVersionProperty&quot;)</span>
<span class="nc" id="L346">                    .paramWithClass(&quot;entityType&quot;, entityPath.getType())</span>
<span class="nc" id="L347">                    .format());</span>
        }

<span class="nc" id="L350">        this.versionPropertyValue = versionPropertyValue;</span>

<span class="nc" id="L352">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; forUpdate() {
<span class="nc" id="L357">        final Dialect dialect = context.getDialect();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if(!dialect.isSupportedSelectForUpdate(SelectForUpdateType.NORMAL)) {</span>
<span class="nc" id="L359">            throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.notSupportSelectForUpdate&quot;)</span>
<span class="nc" id="L360">                    .paramWithClass(&quot;entityType&quot;, entityPath.getType())</span>
<span class="nc" id="L361">                    .param(&quot;dialectName&quot;, dialect.getName())</span>
<span class="nc" id="L362">                    .format());</span>
        }

<span class="nc" id="L365">        this.forUpdateType = SelectForUpdateType.NORMAL;</span>
<span class="nc" id="L366">        return this;</span>
    }

    @Override
    public AutoSelectImpl&lt;T&gt; forUpdateNoWait() {

<span class="nc" id="L372">        final Dialect dialect = context.getDialect();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if(!dialect.isSupportedSelectForUpdate(SelectForUpdateType.NOWAIT)) {</span>
<span class="nc" id="L374">            throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.notSupportSelectForUpdateNowait&quot;)</span>
<span class="nc" id="L375">                    .paramWithClass(&quot;entityType&quot;, entityPath.getType())</span>
<span class="nc" id="L376">                    .param(&quot;dialectName&quot;, dialect.getName())</span>
<span class="nc" id="L377">                    .format());</span>
        }

<span class="nc" id="L380">        this.forUpdateType = SelectForUpdateType.NOWAIT;</span>
<span class="nc" id="L381">        return this;</span>
    }

    /**
     * {@literal FOR UPDATE WAIT} を追加します。
     * @param seconds  ロックを獲得できるまでの最大待機時間(秒単位)
     * @return このインスタンス自身。
     * @throws IllegalOperateException DBMSがこの操作をサポートしていない場合にスローされます。
     */
    public AutoSelectImpl&lt;T&gt; forUpdateWait(final int seconds) {

<span class="nc" id="L392">        final Dialect dialect = context.getDialect();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if(!dialect.isSupportedSelectForUpdate(SelectForUpdateType.WAIT)) {</span>
<span class="nc" id="L394">            throw new IllegalOperateException(context.getMessageFormatter().create(&quot;query.notSupportSelectForUpdateWait&quot;)</span>
<span class="nc" id="L395">                    .paramWithClass(&quot;entityType&quot;, entityPath.getType())</span>
<span class="nc" id="L396">                    .param(&quot;dialectName&quot;, dialect.getName())</span>
<span class="nc" id="L397">                    .format());</span>
        }

<span class="nc" id="L400">        this.forUpdateType = SelectForUpdateType.WAIT;</span>
<span class="nc" id="L401">        this.forUpdateWaitSeconds = seconds;</span>
<span class="nc" id="L402">        return this;</span>
    }

    @Override
    public long getCount() {
<span class="fc" id="L407">        return new AutoSelectExecutor&lt;&gt;(this, true)</span>
<span class="fc" id="L408">                .getCount();</span>
    }

    @Override
    public T getSingleResult() {
<span class="fc" id="L413">        return  new AutoSelectExecutor&lt;&gt;(this, false)</span>
<span class="fc" id="L414">                .getSingleResult(entity -&gt; {</span>
<span class="fc" id="L415">                    context.getApplicationEventPublisher().publishEvent(new PostSelectEvent(AutoSelectImpl.this, entityMeta, entity));</span>
<span class="fc" id="L416">                });</span>
    }

    @Override
    public Optional&lt;T&gt; getOptionalResult() {
<span class="nc" id="L421">        return new AutoSelectExecutor&lt;&gt;(this, false)</span>
<span class="nc" id="L422">                .getOptionalResult(entity -&gt; {</span>
<span class="nc" id="L423">                    context.getApplicationEventPublisher().publishEvent(new PostSelectEvent(AutoSelectImpl.this, entityMeta, entity));</span>
<span class="nc" id="L424">                });</span>
    }

    @Override
    public List&lt;T&gt; getResultList() {
<span class="fc" id="L429">        return new AutoSelectExecutor&lt;&gt;(this, false)</span>
<span class="fc" id="L430">                .getResultList(entity -&gt; {</span>
<span class="fc" id="L431">                    context.getApplicationEventPublisher().publishEvent(new PostSelectEvent(AutoSelectImpl.this, entityMeta, entity));</span>
<span class="fc" id="L432">                });</span>
    }

    @Override
    public Stream&lt;T&gt; getResultStream() {
<span class="fc" id="L437">        return new AutoSelectExecutor&lt;&gt;(this, false)</span>
<span class="fc" id="L438">                .getResultStream(entity -&gt; {</span>
<span class="fc" id="L439">                    context.getApplicationEventPublisher().publishEvent(new PostSelectEvent(AutoSelectImpl.this, entityMeta, entity));</span>
<span class="fc" id="L440">                });</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>