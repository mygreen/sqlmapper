<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SqlMapperAutoConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">sqlmapper-spring-boot-starter</a> &gt; <a href="../index.html" class="el_bundle">sqlmapper-spring-boot-autoconfigure</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.sqlmapper.boot.autoconfigure</a> &gt; <span class="el_source">SqlMapperAutoConfiguration.java</span></div><h1>SqlMapperAutoConfiguration.java</h1><pre class="source lang-java linenums">package com.github.mygreen.sqlmapper.boot.autoconfigure;

import javax.sql.DataSource;

import org.springframework.beans.BeansException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.AutoConfigureAfter;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DatabaseDriver;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.ApplicationEventPublisherAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
import org.springframework.context.support.ResourceBundleMessageSource;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.support.lob.DefaultLobHandler;
import org.springframework.jdbc.support.lob.LobHandler;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionDefinition;
import org.springframework.transaction.support.TransactionTemplate;

import com.github.mygreen.messageformatter.MessageFormatter;
import com.github.mygreen.messageformatter.MessageInterpolator;
import com.github.mygreen.messageformatter.expression.ExpressionEvaluator;
import com.github.mygreen.messageformatter.expression.SpelExpressionEvaluator;
import com.github.mygreen.splate.SqlTemplateEngine;
import com.github.mygreen.sqlmapper.core.SqlMapper;
import com.github.mygreen.sqlmapper.core.SqlMapperContext;
import com.github.mygreen.sqlmapper.core.audit.AuditingEntityListener;
import com.github.mygreen.sqlmapper.core.config.SqlTemplateProperties;
import com.github.mygreen.sqlmapper.core.config.TableIdGeneratorProperties;
import com.github.mygreen.sqlmapper.core.dialect.Dialect;
import com.github.mygreen.sqlmapper.core.dialect.H2Dialect;
import com.github.mygreen.sqlmapper.core.dialect.HsqlDialect;
import com.github.mygreen.sqlmapper.core.dialect.OracleDialect;
import com.github.mygreen.sqlmapper.core.dialect.PostgresDialect;
import com.github.mygreen.sqlmapper.core.dialect.SqliteDialect;
import com.github.mygreen.sqlmapper.core.dialect.StandardDialect;
import com.github.mygreen.sqlmapper.core.meta.EntityMetaFactory;
import com.github.mygreen.sqlmapper.core.meta.PropertyMetaFactory;
import com.github.mygreen.sqlmapper.core.naming.DefaultNamingRule;
import com.github.mygreen.sqlmapper.core.naming.NamingRule;
import com.github.mygreen.sqlmapper.core.type.ValueTypeRegistry;

import lombok.extern.slf4j.Slf4j;

/**
 * SqlMapperによるAuto-Configuration設定
 *
 *
 * @author T.TSUCHIE
 *
 */
<span class="nc" id="L63">@Slf4j</span>
@Configuration
@ConditionalOnClass({ DataSource.class, JdbcTemplate.class})
@ConditionalOnSingleCandidate(DataSource.class)
@PropertySource(&quot;classpath:/com/github/mygreen/sqlmapper/core/sqlmapper.properties&quot;)
@EnableConfigurationProperties(SqlMapperProperties.class)
@AutoConfigureAfter(DataSourceAutoConfiguration.class)
<span class="nc" id="L70">public class SqlMapperAutoConfiguration implements ApplicationContextAware, ApplicationEventPublisherAware {</span>

    /**
     * Springのアプリケーションコンテキスト
     */
    private ApplicationContext applicationContext;

    /**
     * イベントを配信する機能
     */
    private ApplicationEventPublisher applicationEventPublisher;

    @Autowired
    private SqlMapperProperties sqlMapperProperties;

    @Autowired
    private DataSource dataSource;

    @Autowired
    private DataSourceProperties dataSourceProperties;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
<span class="nc" id="L96">       this.applicationContext = applicationContext;</span>
<span class="nc" id="L97">    }</span>

    @Override
    public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {
<span class="nc" id="L101">        this.applicationEventPublisher = applicationEventPublisher;</span>
<span class="nc" id="L102">    }</span>

    @Bean
    @ConditionalOnMissingBean
    public SqlMapper sqlMapper() {
<span class="nc" id="L107">        return new SqlMapper(sqlMapperContext());</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public SqlMapperContext sqlMapperContext() {

<span class="nc" id="L114">        final SqlMapperContext context = new SqlMapperContext();</span>
<span class="nc" id="L115">        context.setJdbcTemplate(jdbcTemplate);</span>
<span class="nc" id="L116">        context.setNamingRule(namingRule());</span>
<span class="nc" id="L117">        context.setMessageFormatter(messageFormatter());</span>
<span class="nc" id="L118">        context.setDialect(dialect());</span>
<span class="nc" id="L119">        context.setEntityMetaFactory(entityMetaFactory());</span>
<span class="nc" id="L120">        context.setApplicationEventPublisher(applicationEventPublisher);</span>
<span class="nc" id="L121">        context.setSqlTemplateEngine(sqlTemplateEngine());</span>
<span class="nc" id="L122">        context.setValueTypeRegistry(valueTypeRegistry());</span>
<span class="nc" id="L123">        context.setIdGeneratorTransactionTemplate(idGeneratorTransactionTemplate());</span>

<span class="nc" id="L125">        return context;</span>

    }

    @Bean
    @ConditionalOnMissingBean
    public SqlTemplateProperties sqlTemplateProperties() {
<span class="nc" id="L132">        return sqlMapperProperties.getSqlTemplate();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public TableIdGeneratorProperties tableIdGeneratorProperties() {
<span class="nc" id="L138">        return sqlMapperProperties.getTableIdGenerator();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public EntityMetaFactory entityMetaFactory() {
<span class="nc" id="L144">        return new EntityMetaFactory();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public PropertyMetaFactory propertyMetaFactory() {
<span class="nc" id="L150">        return new PropertyMetaFactory();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public NamingRule namingRule() {
<span class="nc" id="L156">        return new DefaultNamingRule();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public MessageFormatter messageFormatter() {

<span class="nc" id="L163">        final ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource();</span>
<span class="nc" id="L164">        messageSource.addBasenames(&quot;com/github/mygreen/sqlmapper/core/messages&quot;);</span>
<span class="nc" id="L165">        messageSource.setDefaultEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L166">        messageSource.setUseCodeAsDefaultMessage(true);</span>
<span class="nc" id="L167">        messageSource.setFallbackToSystemLocale(false);</span>

        // SpELで処理する
<span class="nc" id="L170">        final ExpressionEvaluator expressionEvaluator = new SpelExpressionEvaluator();</span>
<span class="nc" id="L171">        final MessageInterpolator messageInterpolator = new MessageInterpolator(expressionEvaluator);</span>

<span class="nc" id="L173">        return new MessageFormatter(messageSource, messageInterpolator);</span>

    }

    @Bean
    @ConditionalOnMissingBean
    public ValueTypeRegistry valueTypeRegistry() {
<span class="nc" id="L180">        return new ValueTypeRegistry();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public SqlTemplateEngine sqlTemplateEngine() {

<span class="nc" id="L187">        final SqlTemplateEngine templateEngine = new SqlTemplateEngine();</span>
<span class="nc" id="L188">        templateEngine.setCached(sqlTemplateProperties().isCacheMode());</span>
<span class="nc" id="L189">        templateEngine.setEncoding(sqlTemplateProperties().getEncoding());</span>
<span class="nc" id="L190">        templateEngine.setSuffixName(dialect().getName());</span>

<span class="nc" id="L192">        return templateEngine;</span>

    }

    @Bean
    @ConditionalOnMissingBean
    public LobHandler lobHandler() {
<span class="nc" id="L199">        return new DefaultLobHandler();</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public JdbcTemplate jdbcTemplate() {
<span class="nc" id="L205">        return new JdbcTemplate(dataSource);</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public Dialect dialect() {

<span class="nc" id="L212">        String url = dataSourceProperties.getUrl();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (url != null) {</span>
<span class="nc" id="L214">            DatabaseDriver databaseDriver = DatabaseDriver.fromJdbcUrl(url);</span>
<span class="nc bnc" id="L215" title="All 6 branches missed.">            switch(databaseDriver) {</span>
                case H2:
<span class="nc" id="L217">                    return new H2Dialect();</span>
                case HSQLDB:
<span class="nc" id="L219">                    return new HsqlDialect();</span>
                case SQLITE:
<span class="nc" id="L221">                    return new SqliteDialect();</span>
                case POSTGRESQL:
<span class="nc" id="L223">                    return new PostgresDialect();</span>
                case ORACLE:
<span class="nc" id="L225">                    return new OracleDialect();</span>
                default:
                    break;
            }
        }

<span class="nc bnc" id="L231" title="All 2 branches missed.">        if(log.isWarnEnabled()) {</span>
<span class="nc" id="L232">            log.warn(&quot;StandardDialect was selected, because not explicit configuration and its is not possible to guess from 'sprint.datasource.url' property.&quot;);</span>
        }

<span class="nc" id="L235">        return new StandardDialect();</span>

    }

    @Bean
    @ConditionalOnMissingBean
    public PlatformTransactionManager transactionManager() {
<span class="nc" id="L242">        return new DataSourceTransactionManager(dataSource);</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public TransactionTemplate idGeneratorTransactionTemplate() {
<span class="nc" id="L248">        TransactionTemplate transactionTemplate = new TransactionTemplate(transactionManager());</span>
<span class="nc" id="L249">        transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW);</span>
<span class="nc" id="L250">        return transactionTemplate;</span>
    }

    @Bean
    @ConditionalOnMissingBean
    public AuditingEntityListener auditingEntityListener() {
<span class="nc" id="L256">        return new AuditingEntityListener();</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>